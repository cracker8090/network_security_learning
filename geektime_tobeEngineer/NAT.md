

# NAT



NAT功能通常被集成到路由器、防火墙、ISDN路由器或者单独的NAT设备中。也可通过软件实现这一功能。

**NAT分为两大类**：

1）基础NAT

​	基础NAT，它仅将内网主机的私有IP地址转换成公网IP地址，但并不将TCP/UDP端口信息进行转换，有动态与静态之区分。

2）NAPT（Network Address/Port Translator）现在大部分都属于NAPT 

​	NAPT**改变**经过这个NAT设备的IP数据报的**IP地址**，还会**改变**IP数据报的**TCP/UDP 端口**。

## NAPT

**NAPT 又分为锥型（Cone）和对称型（Symmetric）** 

锥型NAT可另外分类为：

完全锥形（Full Cone）NAT

受限制锥形（Restricted Cone）NAT

端口受限制锥形（Port Restricted Cone）NAT

①完全锥形（Full Cone）NAT 
这种NAT内部的主机A连接过外网主机C后，NAT会打开一个端口。然后外网的任何发到这个打开的端口的UDP数据报都可以到达A，不管是不是C发过来的[12]。 
例如 A: 192.168.8.100  NAT: 202.100.100.100  C: 292.88.88.88 
A(192.168.8.100:5000) -> NAT(202.100.100.100:8000) -> C(292.88.88.88:2000) 
任何发送到NAT(202.100.100.100:8000)的数据都可以到达A(192.168.8.100:5000)。 
②受限制锥形（Restricted Cone）NAT 
这种NAT内部的主机A连接过外网的主机C后，NAT打开一个端口。然后C可以用任何端口和A通信，但其他的外网主机不可以。 
例如 A: 192.168.8.100  NAT: 202.100.100.100  C: 292.88.88.88 
A(192.168.8.100:5000) -> NAT(202.100.100.100:8000) -> C(292.88.88.88:2000) 
任何从C发送到NAT(202.100.100.100:8000)的数据都可以到达A(192.168.8.100:5000)。 
③端口受限制锥形（Port Restricted Cone）NAT 
这种NAT内部的主机A连接过外网的主机C后，NAT打开一个端口。然后C只能用原来的端口和A通信，其他的外网主机不可以。 
例如 A: 192.168.8.100  NAT: 202.100.100.100  C: 292.88.88.88 
A(192.168.8.100:5000) -> NAT(202.100.100.100:8000) -> C(292.88.88.88:2000) 
只有C(202.88.88.88:2000)发送到 NAT(202.100.100.100:8000)的数据都可以到达A(192.168.8.100:5000)。



 **a、NAT产生的问题**：
   NAT 很好地解决了地址紧缺的问题，屏蔽了内部网络，但也带来一些问题。内网的主机向外连接是很容易的（NAT相当于透明的，内网的和外网的主机均不用知道 NAT的情况）。但如果外部的计算机想访问子网内的计算机就比较困难了，这可以使内网主机先发起连接从而解决问题。但是如果两台主机都分别位于两不同 NAT后面时，两台主机无法通信。

**b、两种解决问题方法**：

   方法一：通过服务器，服务器作为中间人，转发主机间的数据。但若用户数量到达一定数目时，这方法浪费带 宽且给服务器带来很大压力，所以方法不可行。

   方法二：还是通过服务器，但服务器只充当“介绍人”，不转发主机间的数据，具体请看下面的“UDP打孔技术” （UDP hole punching）。

## **穿透NAT―UDP打孔技术** 

所谓的“打孔技术”，就是在内网的NAT设备上打上一个 “孔”（也就是在NAT上建立一个会话，绑定地址和端口号），这个孔不能由外部来打，只能由内网内的主机来打。而且这个孔可能是有方向的，比如从内部某台主机（比如：192.168.0.10）向外部的某个IP(比如：219.237.60.1)发送一个UDP包，那么就在这个内网的NAT设备上打了一个 方向为219.237.60.1的“孔”，以后219.237.60.1就可以通过这个孔与内网的192.168.0.10联系了。 

下面就根据NAT的各种类型详细解析如何“打孔”，如何穿透NAT。 
1．完全锥形（Full Cone）NAT 
处于不同内网的主机A和主机B，各自先连接服务器，从而在各自NAT设备上打开了一个“孔”，服务器收到主机A和主机B的连接后，知道A与B的公网地址和   NAT分配给它们的端口号，然后把这些NAT地址与端口号告诉A与B，由于在完全锥形NAT的特点，A和B给服务器所打开的“孔”，能给别的任何的主机使用。故A与B可连接对方的公网地址和端口直接进行通信。服务器在这里充当“介绍人”，告诉A与B对方的地址和端口号。 

2．受限制锥形（Restricted Cone）NAT 
A和B还是要先连接服务器，服务器发送A和B的地址和端口信息给A和B，但由于受限制锥形NAT的特点，他们所打开的“孔”，只能与服务器通信。要使他们可以直接通信，解决办法如下：假如主机A开始发送一个UDP信息到主机B的公网地址上，与此同时，它又通过服务器中转发送了一个邀请信息给主机B，请求主机B也给主机A发送一个UDP信  息到主机A的公网地址上。这时主机A向主机B的公网IP发送的信息导致NAT A打开一个处于主机A的和主机B之间的会话，与此同时，NAT  B也打开了一个处于主机B和主机A的会话。一旦这个新的UDP会话各自向对方打开了，主机A和主机B之间就可以直接通信了[14]。 

3．端口受限制锥形（Port Restricted Cone）NAT 
对于该类型的NAT，解决办法跟上面的方法一样。 

4．对称型（Symmetric）NAT 
对称型NAT，对于不同的外网主机地址，它都会分配不同的端口号，所以进行UDP打孔比较困难，但也可以进行端口预测打孔，不过不能保证成功。 
以 上的穿透NAT，是对NAPT来进行穿透，主要是针对UDP协议。TCP协议也有可能，但是可行性非常小，要求更高。并且，语音视频通信是用UDP传输   的，故针对TCP的NAT穿透在这里不作讨论。基础NAT不修改经过的数据包的端口号，它们可以看作是完全锥形NAT的精简版本，即基础NAT也可以被穿  透。NAT设备将在一定时间后关闭UDP的一个映射，所以为了保持与服务器能够一直通信，服务器或客户端必须要周期性地发送UDP包，保持映射不被关  闭。 
**目前比较常用的NAT类型是完全锥型NAT**：

①客户端A发UDP数据报经NAT A，把数据发送到服务器。NAT A分配端口给客户端A。服务器接收到信息后，把客户端A经NAT A后的地址及端口信息记录下来。 
②客户端B发UDP数据报经NAT B，把数据发送到服务器。NAT B分配端口给客户端B。服务器接收到信息后，把客户端B经NAT B后的地址及端口信息记录下来。 
③ 服务器把客户端B的地址及端口信息发送给客户端A，把客户端A的地址及端口信息发送给客户端B，客户端A、B就可以通过所获得的对方的地址及端口号进行通信了。

> 现在我们来看看一个P2P软件的流程，以下图为例：
>
>  Server S （219.237.60.1）
>  |
>  +———————–+———————-+
>  |                                            |
>  NAT A (外网IP:202.187.45.3)                NAT B (外网IP:187.34.1.56)
>  |   (内网IP:192.168.0.1)                     | (内网IP:192.168.0.1)
>  |                                            |
>  Client A (192.168.0.20:60000)            Client B (192.168.0.10:40000)
>
>   首先，Client A登录服务器，NAT A为这次的Session分配了一个端口60000，那么ServerS收到的Client  A的地址是202.187.45.3:60000，这就是Client A的外网地址了。同样，ClientB登录Server S，NAT  B给此次Session分配的端口是40000，那么ServerS收到的B的地址是187.34.1.56:40000。
>  此时，Client  A与Client B都可以与ServerS通信了。如果Client A此时想直接发送信息给Client  B，那么他可以从ServerS那儿获得B的公网地址187.34.1.56:40000，是不是Client  A向这个地址发送信息ClientB就能收到了呢？答案是不行，因为如果这样发送信息，NATB会将这个信息丢弃（因为这样的信息是不请自来的，为了安全，大多数NAT都会执行丢弃动作）。那该怎么办呢？   首先我们假设Server  S是219.237.60.1：7000，当Clinet A（202.187.45.3：60000）向Server  S（219.237.60.1：7000）发送数据包，Server S是可以正常接收到数据，因为它是属于外型开放的服务器端口。当Server  S收到数据包后可以获知Clinet  A（202.187.45.3：60000）对外通信的临时session信息（这个叫临时的端口，假设是60000会过期，具体时间不同，一般是每30S发送一个keep住连接以保证端口维持通信连接不断）Server  S此时应将次信息保存起来。而同时，Client B (192.168.0.10:40000)也在时刻向
>  Server  S发送心跳包，Server S就向Client B  (192.168.0.10:40000)发送一个通知，让Client B (192.168.0.10:4000) 发送探测包（这个数据包最好发几个），Client B   (192.168.0.10:4000)在收到通知后在向ServerS发送反馈包，说明以向自己以向Client A   (192.168.0.20:60000)发送了探测包，Server S在收到反馈之后再向ClientA   (192.168.0.20:60000)转发反馈包，Client A   (192.168.0.20:60000)在收到数据包之后在向原本要求请求的Client B (192.168.0.10:4000)发送数据包，此时连接已经打通，实现穿透。Client B   (192.168.0.10:4000)会将数据包转发给
>  Client A  (192.168.0.20:60000)从而在转发给内网内网IP:192.168.0.1。

##  **NAPT具体类型检测** 

前提条件:有一个公网的Server并且绑定了两个公网IP(IP-1,IP-2).这个Server做UDP监听(IP-1,Port-1),(IP-2,Port-2)并根据客户端的要求进行应答. 

第一步：检测客户端是否有能力进行UDP通信以及客户端是否位于NAT后?

客户端建立UDP  socket然后用这个socket向服务器的(IP-1,Port-1)发送数据包要求服务器返回客户端的IP和Port,客户端发送请求后立即开始接受数据包,要设定socket   Timeout(300ms),防止无限堵塞.重复这个过程若干次.如果每次都超时,无法接受到服务器的回应,则说明客户端无法进行UDP通信,可能是防火墙或NAT阻止UDP通信,这样的客户端也就不能P2P了(检测停止).
当客户端能够接收到服务器的回应时,需要把服务器返回的客户端(IP,Port)和这个客户端socket的(LocalIP,LocalPort)比较.如果完全相同则客户端不在NAT后,这样的客户端具有公网IP可以直接监听UDP端口接收数据进行通信(检测停止).否则客户端在NAT后要做进一步的NAT类型检测(继续).  

第二步：检测客户端NAT是否是Symmetric NAT还是Cone NAT? 

客户端建立UDP socket然后用这个socket向服务器的(IP-1,Port-1)发送数据包要求服务器返回客户端的IP和Port,  客户端发送请求后立即开始接受数据包,要设定socket  Timeout(300ms),防止无限堵塞.重复这个过程直到收到回应(一定能够收到,因为第一步保证了这个客户端可以进行UDP通信).
用同样的方法用此socket向服务器的(IP-2,Port-2)发送数据包要求服务器返回客户端的IP和Port.
比较上面两个过程从服务器返回的客户端(IP,Port),如果两个过程返回的(IP,Port)不同则说明客户端为Symmetric  NAT,这样的客户端无法进行UDP-P2P通信(检测停止).否则是Cone NAT,具体Cone NAT类型有待进一步检测(继续).

第三步：检测客户端NAT是否是Full Cone NAT?

客户端建立UDP  socket然后用这个socket向服务器的(IP-1,Port-1)发送数据包要求服务器用另一对(IP-2,Port-2)响应客户端的请求往回发一个数据包,客户端发送请求后立即开始接受数据包,要设定socket  Timeout(300ms),防止无限堵塞.  重复这个过程若干次.如果能够接受到服务器从(IP-2,Port-2)返回的应答UDP包,则说明客户端是一个Full Cone  NAT.(检测停止).如果每次都超时,无法接受到服务器的回应,则说明客户端的NAT不是一个Full Cone  NAT.具体类型还需进一步检测(继续).

第四步：检测客户端NAT是否是Restricted Cone NAT还是Port Restricted Cone NAT?

客户端建立UDP  socket然后用这个socket向服务器的(IP-1,Port-1)发送数据包要求服务器用IP-1和一个不同于Port-1的端口发送一个UDP数据包响应客户端,  客户端发送请求后立即开始接受数据包,要设定socket Timeout(300ms),防止无限堵塞.  重复这个过程若干次.如果每次都超时,无法接受到服务器的回应,则说明客户端是一个Port Restricted Cone  NAT,如果能够收到服务器的响应则说明客户端是一个Restricted Cone NAT.



# P2P技术

点对点技术（peer-to-peer， 简称P2P）又称对等互联网络技术，是一种网络新技术，依赖网络中参与者的计算能力和带宽，而不是把依赖都聚集在较少的几台服务器上（这种技术可以大大减轻服务器的负担）。P2P网络通常用于通过Ad Hoc连接来连接节点（从而实现了节点之间的通讯）。这类网络可以用于多种用途，各种档案分享软件已经得到了广泛的使用（QQ聊天、迅雷、大部分网络播放器都使用了该技术）。

BT源码学习

.torrent文件,这个文件到底有甚么呢

首先是 announce 纪录了发布服务器的位置,让BT知道是那个WEB服务器发布的 

然后是一些文件信息,文件名,目录名,长度等等；最后是片段长度,和片段的 Sha1 校验码(BT为了事现续传和文件校验,就把文件分成若干个片段)，大家可以用写字板打看torrent文件看看,就是知道个大概,后面的乱码是片段 Sha1 校验码































