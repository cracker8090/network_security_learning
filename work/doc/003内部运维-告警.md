

# 内部运维系统告警设计方案

[toc]



# 1.数据来源

目前数据来源主要有两个：矿机端上报和链数据上报。



## 1.1矿机端上报

矿机端的阈值不需要设置，默认矿机端自己知道，根据设置的频率上报。主要通过websocket接口上报。

### 1.1.1坏值告警

- 坏值没有阈值

- 只要磁盘出现坏道就会处理，根据频率来上报



### 1.1.2磁盘空间告警

- 磁盘空间阈值100G，矿机端自己设置，不需要云端设置

- 只要磁盘空间少于100G，根据频率来上报



### 1.1.3CPU温度告警

- CPU温度阈值？，矿机端自己设置，不需要云端设置

- 只要CPU温度高于阈值，根据频率来上报



### 1.1.4磁盘温度告警

- 磁盘温度阈值?，矿机端自己设置，不需要云端设置
- 只要磁盘温度高于阈值，根据频率来上报



## 1.2链数据

链端和云端通过websocket连接，链端会上报数据到云端，还有一些告警需要云端自己来分析上报给用户。

### 1.2.1sector状态异常告警

扇区任务状态失败告警，P1、P2、C1、Finalize、C2失败都会出现告警。

- 告警指标（存在任务状态失败）

  P1失败；

  C1失败；

  P2失败；

  C2失败；

  Finalize失败；



### 1.2.2sector计算效率监控

对扇区计算效率进行监控，当低于设定的效率阈值则会上报告警信息。

- 告警指标（存在任务效率异常，效率阈值）

  P1效率异常；

  C1效率异常；

  P2效率异常；

  C2效率异常；

  Finalize效率异常；



### 1.2.3余额异常告警

实际worker余额的余额低于设定的安全值则会上报告警信息。

- 告警指标（超过设置余额阈值）

  实际worker余额 ＜ 设定的安全值



### 1.2.4算力增速异常告警

当算力增速低于设定的增速标准值时，就会上报告警信息。

- 告警指标（超过设置增速阈值）

  实际算力增长 小于 增速标准

- 概念

  理论增速计算：通过算力机数量、P1任务数进行测算

  增速标准设定：用户自行设定，每个矿工的标准值不一样

  实际算力增速监控：抓取链上算力增长数据



### 1.2.5时空证明异常告警

- 告警指标（证明是否成功）

- 其他

  对象：Partition

  第一阶段：失败

  第二阶段：失败

  第三阶段：失败

  

### 1.2.6订单状态异常告警

当用户订单出现阻塞或者失败时会上报告警信息。

- 告警指标（订单异常）

  阻塞

  失败

  

### 1.2.7链同步异常告警

当主节点区块高度小于设定的标准高度就会上报告警信息。

- 告警指标（超过设置区块高度阈值）

  主节点区块高度 小于 标准高度



### 1.2.8打包权（出块）异常告警

当实际出块率小于理论出块率时就会上报告警信息。

- 告警指标（超过设置出块率阈值）

  实际出块率 ＜ 理论出块率

- 概念

  1、获取矿工中奖数总和（每天）

  2、计算理论中奖数总和（2小时）

  3、计算实际中奖总和与实际中奖次数（2小时）

  4、获取实际出块数（2小时）

  5、判断出块率是否达标：实际中奖总和 ≥ 2小时中奖数据总和（达标），否则不达标



### 1.2.9矿机离线告警

当矿机出现离线时，上报告警信息。

- 告警指标（不需要阈值）

  矿机离线



# 2.用户订阅

主要是用户能够自由选择关心的告警信息进行跟踪，不关心的信息异常可以不用关心。好处就是不同身份的用户都能自由关心自己的信息。

| 可订阅告警类型                                    |
| :------------------------------------------------ |
| 矿机系统告警（坏值、磁盘空间、CPU温度、磁盘温度） |
| sector状态异常告警                                |
| sector计算效率告警                                |
| 余额异常告警                                      |
| 算力增速异常告警                                  |
| 时空证明异常告警                                  |
| 订单状态异常告警                                  |
| 链同步异常告警                                    |
| 打包权异常告警                                    |
| 矿机离线告警                                      |



# 3.可配置项

可配置项包括以下：

- 告警频率可配置

- 告警阈值可配置



## 3.1告警频率配置

**说明**：时空证明异常告警、sector状态异常告警、订单状态异常告警、矿机离线告警的告警频率不需要设置，来了就会上报。

| 告警类型                                          | 告警频率配置     |
| :------------------------------------------------ | ---------------- |
| 矿机系统告警（坏值、磁盘空间、CPU温度、磁盘温度） | 默认值（10分钟） |
| sector计算效率告警                                | 默认值（10分钟） |
| 余额异常告警                                      | 默认值（10分钟） |
| 算力增速异常告警                                  | 默认值（10分钟） |
| 链同步异常告警                                    | 默认值（10分钟） |
| 打包权异常告警                                    | 默认值（10分钟） |



## 3.2告警阈值配置

以下为需要设置阈值的告警

| 告警               | 阈值                                                         |
| ------------------ | ------------------------------------------------------------ |
| sector计算效率告警 | 效率异常                                                     |
| 余额告警           | worker余额安全值设定                                         |
| 算力增速告警       | 算力增速标准设置。每个矿工标准值不一样，通过算力机数量、P1任务数进行测算 |
| 链同步告警         | 主节点区块标准高度设置                                       |
| 打包权告警         | 理论出块率设置                                               |



# 4.告警方式

告警方式主要是指通知用户自己订阅告警的通讯方式，根据自己关注和紧急程度用户自己设置。

## 4.1告警方式种类

- 系统告警（默认都有）

- 邮件（订阅）

- 电话（订阅）

## 4.2两种设置方式

- 方案1 每个告警都可以配置对应的告警方式。

  优点：能够细分化的对订阅的告警进行设置告警方式。

  缺点：用户设置上和开发会复杂一些。

- 方案2 用户统一设置一个告警方式，只要是订阅的告警都按照这个告警方式告知。

  优点：设置简单，用户使用简单。

  缺点：很多都会收到通知，细分程度不够。

**目前采用方案2** 



# 5.告警配置

## 5.1关闭告警

可以通过该开关统一配置告警开闭，默认关闭告警开关没打开



## 5.1告警时间段配置

设置时间段内时间生效，但是需要在关闭告警关闭时才能生效。





# 6.参考

[内部运维系统需求框架整理V2.0_jacky](https://www.tapd.cn/51838973/documents/view/1151838973001001399?file_type=mindmap&file_ext=0) 

[矿机端告警上报参数](https://devppool.arsyun.com/#/userweb/index) 

